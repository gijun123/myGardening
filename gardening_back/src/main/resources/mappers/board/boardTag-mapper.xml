<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ggirick.gardening_back.mappers.board.BoardTag">
    <!-- 게시글 ID로 태그 목록 조회 -->
    <select id="getTagsByBoardId" resultType="com.ggirick.gardening_back.dto.board.BoardTagDTO">
        SELECT
            t.ID,
            t.NAME
        FROM board_tag_mapping m
                 JOIN board_tag t ON m.TAG_ID = t.ID
        WHERE m.BOARD_ID = #{boardId}
    </select>


    <!-- 태그명 조회 (lower-case 기준으로 비교) -->
    <select id="getTagByName" parameterType="string" resultType="com.ggirick.gardening_back.dto.board.BoardTagDTO">
        SELECT id, name
        FROM board_tag
        WHERE LOWER(name) = LOWER(#{tagName})
            FETCH FIRST 1 ROWS ONLY
    </select>


    <!-- 새 태그 등록 (ID 자동 증가값 반환) -->
    <insert id="insertTag" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO board_tag (NAME)
        VALUES (#{name})
    </insert>


    <!-- 게시글-태그 매핑 저장 -->
    <insert id="insertMapping">
        INSERT INTO board_tag_mapping (BOARD_ID, TAG_ID)
        VALUES (#{boardId}, #{tagId})
    </insert>


    <!-- 게시글 삭제 시 태그 매핑 삭제 -->
    <delete id="deleteMappingsByBoardId">
        DELETE FROM board_tag_mapping
        WHERE BOARD_ID = #{boardId}
    </delete>

</mapper>